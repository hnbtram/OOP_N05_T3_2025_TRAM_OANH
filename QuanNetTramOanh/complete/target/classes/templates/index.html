<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Quán Net</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --border-color: #dee2e6;
            --accent-color: #17a2b8;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--secondary-color);
            padding-top: 70px;
        }

        .navbar {
            background-color: var(--card-bg-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        
        .navbar-brand img {
            height: 40px;
        }

        .nav-link {
            color: var(--secondary-color) !important;
            transition: all 0.3s ease-in-out;
            padding: 1rem;
        }
        
        .nav-link.active, .nav-link:hover {
            color: var(--primary-color) !important;
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }

        .container-fluid {
            padding-left: 2rem;
            padding-right: 2rem;
        }

        .main-content {
            padding: 2rem;
        }
        
        .card {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        .card-header {
            background-color: var(--card-bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .btn-primary, .btn-success, .btn-warning, .btn-danger {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            color: white;
        }
        .status-idle { background-color: #6c757d; }
        .status-active { background-color: #28a745; }
        .status-maintenance { background-color: #ffc107; }
        .status-broken { background-color: #dc3545; }

        .receipt {
            background-color: #f1f7ff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 1px dashed #c1d9ff;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .receipt-total {
            border-bottom: none;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 1rem;
        }

        .tab-pane {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-gamepad me-2 text-primary"></i>
                <span class="fw-bold">QUẢN LÝ QUÁN NET</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#booking-tab-content">
                            <i class="fas fa-cash-register me-2"></i>Đặt chỗ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#customers-tab-content">
                            <i class="fas fa-users me-2"></i>Khách hàng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#computers-tab-content">
                            <i class="fas fa-desktop me-2"></i>Máy tính
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#services-tab-content">
                            <i class="fas fa-concierge-bell me-2"></i>Dịch vụ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#history-tab-content">
                            <i class="fas fa-history me-2"></i>Lịch sử
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#statistics-tab-content">
                            <i class="fas fa-chart-bar me-2"></i>Thống kê
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="booking-tab-content">
                <div class="card p-4">
                    <div class="row">
                        <div class="col-lg-6 mb-4 mb-lg-0">
                            <h3 class="mb-4 text-primary">
                                <i class="fas fa-cash-register me-2"></i>
                                Đặt chỗ & Thanh toán
                            </h3>
                            <form id="bookingForm">
                                <div class="mb-3">
                                    <label for="fullName" class="form-label">Họ và tên</label>
                                    <input type="text" class="form-control" id="fullName" placeholder="Nhập họ và tên khách hàng" required>
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Số điện thoại</label>
                                    <input type="tel" class="form-control" id="phone" placeholder="Nhập số điện thoại" required>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="startTime" class="form-label">Thời gian bắt đầu</label>
                                        <input type="datetime-local" class="form-control" id="startTime" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="endTime" class="form-label">Thời gian kết thúc</label>
                                        <input type="datetime-local" class="form-control" id="endTime" required>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label for="computerSelect" class="form-label">Chọn máy tính</label>
                                    <select class="form-select" id="computerSelect" required>
                                        <option value="" selected disabled>-- Chọn máy --</option>
                                    </select>
                                </div>
                                <h5 class="mb-3 text-secondary">Chọn dịch vụ</h5>
                                <div id="serviceSelection" class="row g-3">
                                    </div>
                                <div class="d-grid mt-4">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="calculateBill()">
                                        <i class="fas fa-calculator me-2"></i>
                                        Tính tiền
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-lg-6">
                            <div class="receipt" id="receiptContainer" style="display: none;">
                                <h4 class="text-center mb-4 text-primary">HÓA ĐƠN THANH TOÁN</h4>
                                <div class="receipt-item">
                                    <span>Tên khách:</span>
                                    <span id="receiptName" class="fw-bold"></span>
                                </div>
                                <div class="receipt-item">
                                    <span>SĐT:</span>
                                    <span id="receiptPhone"></span>
                                </div>
                                <div class="receipt-item">
                                    <span>Máy sử dụng:</span>
                                    <span id="receiptComputer"></span>
                                </div>
                                <div class="receipt-item">
                                    <span>Thời gian chơi:</span>
                                    <span id="receiptDuration"></span>
                                </div>
                                <div class="receipt-item">
                                    <span>Tiền giờ chơi:</span>
                                    <span id="receiptComputerCost"></span>
                                </div>
                                <div class="receipt-item">
                                    <span>Tiền dịch vụ:</span>
                                    <span id="receiptServicesTotal"></span>
                                </div>
                                <div class="receipt-item receipt-total">
                                    <span>TỔNG CỘNG:</span>
                                    <span id="receiptTotal"></span>
                                </div>
                                <div class="d-flex mt-4 gap-2">
                                    <button class="btn btn-success flex-grow-1" onclick="saveTransaction()">
                                        <i class="fas fa-check-circle me-2"></i>Thanh toán
                                    </button>
                                    <button class="btn btn-warning flex-grow-1" onclick="resetForm()">
                                        <i class="fas fa-redo me-2"></i>Đặt lại
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="customers-tab-content">
                <div class="card p-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 text-primary"><i class="fas fa-users me-2"></i>Quản lý Khách hàng</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                            <i class="fas fa-plus me-2"></i>Thêm khách hàng
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Mã KH</th>
                                        <th>Họ tên</th>
                                        <th>SĐT</th>
                                        <th>Tổng chi</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="customerTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="computers-tab-content">
                <div class="card p-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 text-primary"><i class="fas fa-desktop me-2"></i>Quản lý Máy tính</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addComputerModal">
                            <i class="fas fa-plus me-2"></i>Thêm máy
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Mã máy</th>
                                        <th>Tên máy</th>
                                        <th>Giá/giờ</th>
                                        <th>Trạng thái</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="computerTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="services-tab-content">
                <div class="card p-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 text-primary"><i class="fas fa-concierge-bell me-2"></i>Quản lý Dịch vụ</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal">
                            <i class="fas fa-plus me-2"></i>Thêm dịch vụ
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Tên dịch vụ</th>
                                        <th>Giá</th>
                                        <th>Trạng thái</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="serviceTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="history-tab-content">
                <div class="card p-4">
                    <div class="card-header">
                        <h4 class="mb-0 text-primary"><i class="fas fa-history me-2"></i>Lịch sử Giao dịch</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Mã GD</th>
                                        <th>Ngày giao dịch</th>
                                        <th>Khách hàng</th>
                                        <th>Tổng tiền</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="statistics-tab-content">
                <div class="card p-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 text-primary"><i class="fas fa-chart-bar me-2"></i>Thống kê tổng quan</h4>
                        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                            <i class="fas fa-minus me-2"></i>Thêm chi phí
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-4 g-3">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white p-3">
                                    <h5>Doanh thu tháng này</h5>
                                    <h3 id="monthlyRevenue">0 VND</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning text-dark p-3">
                                    <h5>Chi phí tháng này</h5>
                                    <h3 id="monthlyExpenses">0 VND</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white p-3">
                                    <h5>Lợi nhuận tháng này</h5>
                                    <h3 id="monthlyProfit">0 VND</h3>
                                </div>
                            </div>
                        </div>
                        <h5 class="mt-4 text-secondary">Thống kê chi tiết theo tháng</h5>
                        <div class="table-responsive mt-3">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Tháng</th>
                                        <th>Doanh thu</th>
                                        <th>Chi phí</th>
                                        <th>Lợi nhuận</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyStatsTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm khách hàng mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newCustomerForm">
                        <div class="mb-3">
                            <label for="newCustomerName" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="newCustomerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newCustomerPhone" class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control" id="newCustomerPhone" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">Lưu</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa khách hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="editCustomerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control" id="editCustomerPhone" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addComputerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm máy tính mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newComputerForm">
                        <div class="mb-3">
                            <label for="newComputerName" class="form-label">Tên máy</label>
                            <input type="text" class="form-control" id="newComputerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newComputerPrice" class="form-label">Giá mỗi giờ (VND)</label>
                            <input type="number" class="form-control" id="newComputerPrice" value="15000" min="10000" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="addComputer()">Thêm máy</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editComputerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa máy tính</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editComputerForm">
                        <input type="hidden" id="editComputerId">
                        <div class="mb-3">
                            <label for="editComputerName" class="form-label">Tên máy</label>
                            <input type="text" class="form-control" id="editComputerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editComputerPrice" class="form-label">Giá mỗi giờ (VND)</label>
                            <input type="number" class="form-control" id="editComputerPrice" min="10000" required>
                        </div>
                        <div class="mb-3">
                            <label for="editComputerStatus" class="form-label">Trạng thái</label>
                            <select class="form-select" id="editComputerStatus" required>
                                <option value="idle">Đang rảnh</option>
                                <option value="active">Đang hoạt động</option>
                                <option value="maintenance">Bảo trì</option>
                                <option value="broken">Hỏng</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="updateComputer()">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addServiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm dịch vụ mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newServiceForm">
                        <div class="mb-3">
                            <label for="newServiceName" class="form-label">Tên dịch vụ</label>
                            <input type="text" class="form-control" id="newServiceName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newServicePrice" class="form-label">Giá (VND)</label>
                            <input type="number" class="form-control" id="newServicePrice" min="1000" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="addService()">Thêm dịch vụ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editServiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa dịch vụ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editServiceForm">
                        <input type="hidden" id="editServiceId">
                        <div class="mb-3">
                            <label for="editServiceName" class="form-label">Tên dịch vụ</label>
                            <input type="text" class="form-control" id="editServiceName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editServicePrice" class="form-label">Giá (VND)</label>
                            <input type="number" class="form-control" id="editServicePrice" min="1000" required>
                        </div>
                        <div class="mb-3">
                            <label for="editServiceStatus" class="form-label">Trạng thái</label>
                            <select class="form-select" id="editServiceStatus" required>
                                <option value="active">Hoạt động</option>
                                <option value="inactive">Ngừng bán</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="updateService()">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addExpenseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm chi phí phát sinh</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newExpenseForm">
                        <div class="mb-3">
                            <label for="newExpenseDescription" class="form-label">Mô tả chi phí</label>
                            <input type="text" class="form-control" id="newExpenseDescription" required>
                        </div>
                        <div class="mb-3">
                            <label for="newExpenseAmount" class="form-label">Số tiền (VND)</label>
                            <input type="number" class="form-control" id="newExpenseAmount" min="0" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" onclick="addExpense()">Thêm chi phí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        
        let customers = [];
        let computers = [];
        let services = [];

        function formatCurrency(number) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
        }
        
        function resetForm() {
            document.getElementById('bookingForm').reset();
            document.getElementById('receiptContainer').style.display = 'none';
            services.forEach(service => {
                const quantityInput = document.getElementById(`service-qty-${service.id}`);
                if (quantityInput) quantityInput.value = 0;
            });
            loadData();
        }

        // Render Functions
        function renderCustomers() {
            const customerTableBody = document.getElementById('customerTable');
            customerTableBody.innerHTML = '';
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${formatCurrency(customer.total_spent)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="editCustomer('${customer.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('${customer.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                customerTableBody.appendChild(row);
            });
        }

        function renderComputers() {
            const computerTableBody = document.getElementById('computerTable');
            computerTableBody.innerHTML = '';
            const computerSelect = document.getElementById('computerSelect');
            computerSelect.innerHTML = '<option value="" selected disabled>-- Chọn máy --</option>';

            computers.forEach(computer => {
                const row = document.createElement('tr');
                let statusClass = '';
                let statusText = '';
                switch (computer.status) {
                    case 'idle': statusClass = 'status-idle'; statusText = 'Đang rảnh'; break;
                    case 'active': statusClass = 'status-active'; statusText = 'Đang hoạt động'; break;
                    case 'maintenance': statusClass = 'status-maintenance'; statusText = 'Bảo trì'; break;
                    case 'broken': statusClass = 'status-broken'; statusText = 'Hỏng'; break;
                }
                row.innerHTML = `
                    <td>${computer.id.toUpperCase()}</td>
                    <td>${computer.name}</td>
                    <td>${formatCurrency(computer.price_per_hour)}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="editComputer('${computer.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteComputer('${computer.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                computerTableBody.appendChild(row);

                if (computer.status === 'idle') {
                    const option = document.createElement('option');
                    option.value = computer.id;
                    option.textContent = `${computer.name} - ${formatCurrency(computer.price_per_hour)}/giờ`;
                    computerSelect.appendChild(option);
                }
            });
        }

        function renderServices() {
            const serviceTableBody = document.getElementById('serviceTable');
            serviceTableBody.innerHTML = '';
            const serviceSelectionDiv = document.getElementById('serviceSelection');
            serviceSelectionDiv.innerHTML = '';
            
            services.forEach(service => {
                const row = document.createElement('tr');
                let statusClass = service.status === 'active' ? 'status-active' : 'status-broken';
                let statusText = service.status === 'active' ? 'Hoạt động' : 'Ngừng bán';
                row.innerHTML = `
                    <td>${service.name}</td>
                    <td>${formatCurrency(service.price)}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="editService('${service.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteService('${service.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                serviceTableBody.appendChild(row);
                
                if (service.status === 'active') {
                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    col.innerHTML = `
                        <div class="input-group">
                            <span class="input-group-text">${service.name}</span>
                            <input type="number" class="form-control" id="service-qty-${service.id}" min="0" value="0">
                            <span class="input-group-text">${formatCurrency(service.price)}</span>
                        </div>
                    `;
                    serviceSelectionDiv.appendChild(col);
                }
            });
        }
        
        function renderTransactions() {
            const historyTableBody = document.getElementById('historyTable');
            historyTableBody.innerHTML = '';
            // Giao dịch sẽ được tải từ API và render tại đây
        }
        
        function renderMonthlyStats() {
            // Thống kê sẽ được tải từ API và render tại đây
            document.getElementById('monthlyRevenue').textContent = formatCurrency(0);
            document.getElementById('monthlyExpenses').textContent = formatCurrency(0);
            document.getElementById('monthlyProfit').textContent = formatCurrency(0);
        }

        // Business Logic
        async function loadData() {
            try {
                const [customersRes, computersRes, servicesRes] = await Promise.all([
                    fetch(`${API_URL}/customers`),
                    fetch(`${API_URL}/computers`),
                    fetch(`${API_URL}/services`)
                ]);
                customers = await customersRes.json();
                computers = await computersRes.json();
                services = await servicesRes.json();

                renderCustomers();
                renderComputers();
                renderServices();
                renderTransactions();
                renderMonthlyStats();
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                alert('Không thể kết nối tới server. Vui lòng kiểm tra server đã chạy chưa!');
            }
        }

        function calculateBill() {
            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const startTimeStr = document.getElementById('startTime').value;
            const endTimeStr = document.getElementById('endTime').value;
            const computerId = document.getElementById('computerSelect').value;
            
            if (!fullName || !phone || !startTimeStr || !endTimeStr || !computerId) {
                alert('Vui lòng điền đầy đủ thông tin đặt chỗ.');
                return;
            }
            
            const startTime = new Date(startTimeStr);
            const endTime = new Date(endTimeStr);

            if (endTime <= startTime) {
                alert('Thời gian kết thúc phải lớn hơn thời gian bắt đầu.');
                return;
            }
            
            const computer = computers.find(c => c.id === computerId);
            const durationInHours = (endTime - startTime) / (1000 * 60 * 60);
            const computerCost = durationInHours * computer.price_per_hour;

            let serviceCost = 0;
            let selectedServices = [];
            services.forEach(service => {
                const quantityInput = document.getElementById(`service-qty-${service.id}`);
                const quantity = parseInt(quantityInput.value) || 0;
                if (quantity > 0) {
                    serviceCost += quantity * service.price;
                    selectedServices.push({
                        id: service.id,
                        name: service.name,
                        price: service.price,
                        quantity: quantity
                    });
                }
            });
            
            const total = computerCost + serviceCost;

            document.getElementById('receiptContainer').style.display = 'block';
            document.getElementById('receiptName').textContent = fullName;
            document.getElementById('receiptPhone').textContent = phone;
            document.getElementById('receiptComputer').textContent = computer.name;
            document.getElementById('receiptDuration').textContent = `${durationInHours.toFixed(2)} giờ`;
            document.getElementById('receiptComputerCost').textContent = formatCurrency(computerCost);
            document.getElementById('receiptServicesTotal').textContent = formatCurrency(serviceCost);
            document.getElementById('receiptTotal').textContent = formatCurrency(total);
        }
        
        async function saveTransaction() {
            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const computerId = document.getElementById('computerSelect').value;
            const startTimeStr = document.getElementById('startTime').value;
            const endTimeStr = document.getElementById('endTime').value;
            const totalStr = document.getElementById('receiptTotal').textContent;
            const totalAmount = parseInt(totalStr.replace(/[^0-9]/g, '')) || 0;
            
            let customer = customers.find(c => c.phone === phone);
            let customerId = customer ? customer.id : null;
            
            if (!customer) {
                const newId = `KH${String(customers.length + 1).padStart(3, '0')}`;
                const newCustomer = { id: newId, name: fullName, phone: phone };
                const res = await fetch(`${API_URL}/customers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newCustomer)
                });
                const result = await res.json();
                if (result.success) {
                    customerId = newId;
                } else {
                    alert('Lỗi khi thêm khách hàng mới.');
                    return;
                }
            }

            const serviceDetails = [];
            services.forEach(service => {
                const quantityInput = document.getElementById(`service-qty-${service.id}`);
                const quantity = parseInt(quantityInput.value) || 0;
                if (quantity > 0) {
                    serviceDetails.push({ id: service.id, price: service.price, quantity: quantity });
                }
            });

            const transactionData = {
                customerId,
                computerId,
                startTime: startTimeStr,
                endTime: endTimeStr,
                totalAmount,
                serviceDetails
            };

            try {
                const response = await fetch(`${API_URL}/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Thanh toán thành công!');
                    resetForm();
                    loadData();
                } else {
                    alert('Thanh toán thất bại: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi khi gửi giao dịch:', error);
                alert('Không thể kết nối tới server để thanh toán.');
            }
        }

        // CRUD Functions for Customers (đã được sửa để dùng API)
        async function addCustomer() {
            const name = document.getElementById('newCustomerName').value;
            const phone = document.getElementById('newCustomerPhone').value;
            const newId = `KH${String(customers.length + 1).padStart(3, '0')}`;
            const newCustomer = { id: newId, name, phone };

            try {
                const response = await fetch(`${API_URL}/customers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newCustomer)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Thêm khách hàng thành công!');
                    loadData();
                    document.getElementById('newCustomerForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                } else {
                    alert('Thêm khách hàng thất bại: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi khi thêm khách hàng:', error);
            }
        }

        async function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            document.getElementById('editCustomerId').value = customer.id;
            document.getElementById('editCustomerName').value = customer.name;
            document.getElementById('editCustomerPhone').value = customer.phone;
            const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
            modal.show();
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('editCustomerName').value;
            const phone = document.getElementById('editCustomerPhone').value;

            try {
                const response = await fetch(`${API_URL}/customers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone })
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Cập nhật thành công!');
                    loadData();
                    bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
                } else {
                    alert('Cập nhật thất bại: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật khách hàng:', error);
            }
        }

        async function deleteCustomer(id) {
            if (confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
                try {
                    const response = await fetch(`${API_URL}/customers/${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Xóa khách hàng thành công!');
                        loadData();
                    } else {
                        alert('Xóa khách hàng thất bại: ' + result.message);
                    }
                } catch (error) {
                    console.error('Lỗi khi xóa khách hàng:', error);
                }
            }
        }
        
        // ... Các hàm CRUD khác cho Computers, Services, Expenses cần được viết tương tự
        // Hiện tại chỉ có các hàm cơ bản cho customer và transaction được sửa để minh họa

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>